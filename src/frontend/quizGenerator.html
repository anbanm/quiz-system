<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Builder for Teachers</title>
    <script src="jszip.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            margin: 20px;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            color: #333;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
            transition: 0.3s;
            font-weight: bold;
        }
        button:hover {
            background-color: #2980b9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #questionList, #jsonOutput {
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        ul {
            padding-left: 20px;
        }
        ul li {
            background: #ecf0f1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        ul li button {
            background: #e74c3c;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        ul li button:hover {
            background: #c0392b;
        }
        img#imagePreview {
            display: block;
            width: 100px;
            height: auto;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Question reordering styles */
        .question-card.dragging {
            opacity: 0.3;
            transform: rotate(3deg) scale(1.02);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .question-card.drag-over-top {
            border-top: 4px solid #3498db !important;
            transform: translateY(-3px);
            transition: all 0.2s ease;
        }
        
        .question-card.drag-over-bottom {
            border-bottom: 4px solid #3498db !important;
            transform: translateY(3px);
            transition: all 0.2s ease;
        }

        .drag-handle:hover {
            background-color: #ecf0f1;
            border-radius: 4px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Animations for success messages */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes scaleOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Mobile-friendly touch targets for reordering */
        @media (max-width: 768px) {
            .question-card {
                margin: 15px 0 !important;
            }
            
            .question-card div[style*="flex-direction: column"] button {
                min-height: 44px !important;
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            #add-another-prompt {
                margin: 15px 0 !important;
                padding: 15px !important;
            }
            
            #add-another-prompt div[style*="flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">üìö Quiz Builder for Teachers</h1>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Create engaging quizzes for your students in just a few simple steps!</p>

    <div style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #3498db;">
        <strong>üìÇ Open Existing Quiz:</strong>
        <input type="file" id="jsonUpload" accept="application/json" onchange="loadJSON(event)" style="margin-top: 10px;">
        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Upload a previously saved quiz file to continue editing</small>
    </div>


    <div id="testSelectContainer" style="display: none;">  </div>

    <div style="text-align: center; margin: 30px 0;">
        <button onclick="createNewTest()" style="background: #27ae60; font-size: 18px; padding: 15px 30px; border-radius: 8px;">
            ‚ú® Create New Quiz
        </button>
    </div>

</div>

<div id="testDetailsContainer" style="display: none;" class="container" style="margin-top: 20px;">
    <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">üìù Quiz Details</h2>
    
    <div style="margin: 20px 0;">
        <label style="color: #2c3e50; font-size: 16px;">üìö Quiz Name:</label>
        <input type="text" id="testName" placeholder="e.g., Math Chapter 5 Quiz, Science Test #1..." style="font-size: 16px;">
        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Give your quiz a descriptive name that students will recognize</small>
    </div>

    <details style="margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        <summary style="cursor: pointer; font-weight: bold; color: #7f8c8d;">‚öôÔ∏è Advanced Settings (Optional)</summary>
        <div style="margin-top: 10px;">
            <label>Quiz ID:</label>
            <input type="text" id="testId" placeholder="Generated automatically" readonly>
            <button onclick="generateTestId()" style="background: #95a5a6; font-size: 14px;">Generate New ID</button>
        </div>
    </details>

    <h2 id="question-form-section" style="color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 30px;">‚ùì Add Questions</h2>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
        <strong>üí° Quick Tips:</strong>
        <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
            <li>Write clear, specific questions</li>
            <li>Make sure only one answer is clearly correct</li>
            <li>Add images to make questions more engaging</li>
            <li>Use different difficulty levels to challenge all students</li>
        </ul>
    </div>

    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 8px; border: 2px solid #e8f4fd;">
        <label style="color: #2c3e50; font-size: 16px; font-weight: bold; display: block; margin-bottom: 10px;">‚ùì Your Question:</label>
        <textarea id="question" placeholder="What is the capital of France?" style="width: 100%; height: 80px; resize: vertical; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; padding: 12px; font-family: inherit;"></textarea>
        <small style="color: #7f8c8d; display: block; margin-top: 8px; font-style: italic;">üí° Write a clear, specific question for your students</small>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <label style="color: #2c3e50; font-size: 16px;">üñºÔ∏è Add Image (Optional):</label>
        <input type="text" id="imagePath" placeholder="No image selected" readonly style="margin-top: 10px;">
        <button onclick="document.getElementById('fileInput').click()" style="background: #17a2b8; margin-top: 10px;">üìÅ Choose Image</button>
        <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="handleFileSelect(event)">
        <img id="imagePreview" style="display:none; max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Images help students understand the question better</small>
    </div>

    <div style="margin: 20px 0;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üìù Answer Options:</h3>
        
        <div style="display: grid; gap: 10px;">
            <div>
                <label style="color: #27ae60; font-weight: bold;">A)</label>
                <input type="text" id="option1" placeholder="First answer option" style="margin-left: 10px;">
            </div>
            <div>
                <label style="color: #f39c12; font-weight: bold;">B)</label>
                <input type="text" id="option2" placeholder="Second answer option" style="margin-left: 10px;">
            </div>
            <div>
                <label style="color: #3498db; font-weight: bold;">C)</label>
                <input type="text" id="option3" placeholder="Third answer option" style="margin-left: 10px;">
            </div>
            <div>
                <label style="color: #e74c3c; font-weight: bold;">D)</label>
                <input type="text" id="option4" placeholder="Fourth answer option" style="margin-left: 10px;">
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
        <div>
            <label style="color: #2c3e50; font-weight: bold;">‚úÖ Correct Answer:</label>
            <select id="correctAnswer" style="margin-top: 5px; font-size: 16px; padding: 8px;">
                <option value="option1">A</option>
                <option value="option2">B</option>
                <option value="option3">C</option>
                <option value="option4">D</option>
            </select>
        </div>
        
        <div>
            <label style="color: #2c3e50; font-weight: bold;">‚≠ê Points:</label>
            <input type="number" id="points" value="1" min="1" max="10" style="margin-top: 5px; font-size: 16px; padding: 8px;">
        </div>
        
        <div>
            <label style="color: #2c3e50; font-weight: bold;">üìä Difficulty:</label>
            <select id="difficulty" style="margin-top: 5px; font-size: 16px; padding: 8px;">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
            </select>
        </div>
    </div>

    <div style="margin: 20px 0;">
        <label style="color: #2c3e50; font-weight: bold;">üìÇ Subject/Category:</label>
        <input type="text" id="category" placeholder="e.g., Math, Science, History..." style="margin-top: 5px;">
        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Help organize your questions by subject or topic</small>
    </div>

    <div style="text-align: center; margin: 30px 0;">
        <button onclick="addOrUpdateQuestion()" style="background: #27ae60; font-size: 18px; padding: 15px 30px; border-radius: 8px;">
            ‚ûï Add Question to Quiz
        </button>
    </div>


    <div style="margin-top: 40px; padding: 20px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">üìä Quiz Summary</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0; color: #3498db;">üìù Questions</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #2c3e50;" id="questionCount">0</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0; color: #f39c12;">‚≠ê Total Points</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #2c3e50;" id="totalPointsDisplay">0</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0; color: #e74c3c;">üìä Difficulty Mix</h3>
                <p style="font-size: 14px; margin: 10px 0; color: #2c3e50;" id="difficultyBreakdown">-</p>
            </div>
        </div>
    </div>

    <div id="questionList" style="margin-top: 30px;">
        <h2 style="color: #2c3e50; border-bottom: 2px solid #9b59b6; padding-bottom: 10px;">üìã Your Questions</h2>
        <div id="questions" style="margin-top: 20px;"></div>
        <div id="emptyState" style="text-align: center; padding: 40px; color: #7f8c8d; display: block;">
            <p style="font-size: 18px;">üìù No questions added yet</p>
            <p>Add your first question above to get started!</p>
        </div>
    </div>

    <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">üíæ Save Your Quiz</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <button onclick="generateJSON()" style="background: #3498db; padding: 15px; border-radius: 8px;">
                üëÄ Preview Quiz Data
            </button>
            <button onclick="downloadZIP()" style="background: #27ae60; padding: 15px; border-radius: 8px;">
                üì¶ Download ZIP Package
            </button>
            <button onclick="downloadJSON()" style="background: #95a5a6; padding: 15px; border-radius: 8px;">
                üìÑ Download JSON Only
            </button>
        </div>
        
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #27ae60;">üí° Download Options:</h4>
            <p style="margin: 5px 0; font-size: 14px;"><strong>üì¶ ZIP Package:</strong> Complete quiz with images in separate folder (recommended for sharing)</p>
            <p style="margin: 5px 0; font-size: 14px;"><strong>üìÑ JSON Only:</strong> Lightweight file with embedded images (larger file size)</p>
        </div>
        
        <details style="margin-top: 20px;">
            <summary style="cursor: pointer; font-weight: bold; color: #7f8c8d;">üìÑ View Quiz Data (Technical)</summary>
            <div id="jsonOutput" style="margin-top: 15px; padding: 15px; background: #2c3e50; color: #ecf0f1; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>
        </details>
    </div>


</div>

<script>
    let quizData = { tests: [] }; // Store all tests
    let currentTestIndex = -1;      // Index of the currently selected test
    let currentQuestionIndex = null // Index of the currently selected question

    function getImageExtension(imagePath) {
        if (!imagePath) return 'jpg';
        if (imagePath.startsWith('data:image/')) {
            const match = imagePath.match(/data:image\/([^;]+)/);
            let ext = match ? match[1] : 'jpg';
            // Convert jpeg to jpg for consistency
            return ext === 'jpeg' ? 'jpg' : ext;
        }
        const ext = imagePath.split('.').pop().toLowerCase();
        // Convert jpeg to jpg for consistency
        const normalizedExt = ext === 'jpeg' ? 'jpg' : ext;
        return ['jpg', 'png', 'gif', 'webp'].includes(normalizedExt) ? normalizedExt : 'jpg';
    }

    function generateTestId() {
        const testId = 'test-' + Math.floor(Math.random() * 1000000);
        document.getElementById("testId").value = testId;

        // Update testName from the input element
        const testNameInput = document.getElementById("testName").value;
        quizData.tests[currentTestIndex].testName = testNameInput;

        return testId;    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('imagePath').value = file.name;
            
            // Show image preview and store the data URL for later use
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // Store the image data URL for editing purposes
                preview.dataset.imageData = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    async function ensureImageInDirectory(file, filePath) {
        try {
            const dirHandle = await window.showDirectoryPicker();
            let fileHandle;
            try {
                fileHandle = await dirHandle.getFileHandle(filePath, { create: false });
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    fileHandle = await dirHandle.getFileHandle(filePath, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(file);
                    await writable.close();
                } else {
                    throw error;
                }
            }
        } catch (error) {
            console.error("Error accessing file system:", error);
        }
    }




    function loadJSON(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (!loadedData || !loadedData.tests || !Array.isArray(loadedData.tests)) {
                        quizData = { tests: [] }; // Reset if the structure is invalid
                        return;
                    }
                    
                    // Convert loaded data to internal format
                    quizData = {
                        tests: loadedData.tests.map(test => ({
                            testName: test.testName,
                            testId: test.testID || test.testId, // Handle both formats
                            questions: test.questions.map(q => {
                                // Convert from export format back to internal format
                                if (q.options && typeof q.options === 'object') {
                                    // New format with A/B/C/D object
                                    return {
                                        question: q.question,
                                        image: q.image,
                                        imagePreviewData: q.image && q.image.startsWith('data:') ? q.image : null, // Only use data URLs as preview data
                                        option1: q.options.A,
                                        option2: q.options.B,
                                        option3: q.options.C,
                                        option4: q.options.D,
                                        correctAnswer: q.correctAnswer === 'A' ? 'option1' :
                                                      q.correctAnswer === 'B' ? 'option2' :
                                                      q.correctAnswer === 'C' ? 'option3' :
                                                      q.correctAnswer === 'D' ? 'option4' : 'option1',
                                        category: q.category,
                                        difficulty: q.difficulty,
                                        points: q.points || 1,
                                        id: q.id || 'q-' + Math.floor(Math.random() * 1000000)
                                    };
                                } else {
                                    // Old format - return as is
                                    return q;
                                }
                            })
                        }))
                    };
                    
                    populateTestSelect();
                } catch (error) {
                    alert("Error parsing JSON: " + error.message);
                }
            };
            reader.readAsText(file);
        }
    }


    function populateTestSelect() {
        const testSelectContainer = document.getElementById("testSelectContainer");
        testSelectContainer.innerHTML = ""; // Clear previous options

        if (quizData.tests.length > 0) {
            const select = document.createElement("select");
            select.id = "testSelect";
            select.onchange = () => selectTest(parseInt(select.value));

            quizData.tests.forEach((test, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = test.testName || `Test ${index + 1}`;
                select.appendChild(option);
            });

            testSelectContainer.appendChild(select);
            testSelectContainer.style.display = "block";
            selectTest(0); // Select the first test by default if there are any tests.
        } else {
            testSelectContainer.style.display = "none";
        }
        document.getElementById("testDetailsContainer").style.display = "block";
    }

    function selectTest(index) {
        currentTestIndex = index;
        const test = quizData.tests[index];

        const testNameInput = document.getElementById("testName");
        testNameInput.value = test.testName;
        testNameInput.onchange = () => {
            test.testName = testNameInput.value;
        };

        document.getElementById("testId").value = test.testId;

        // Load Questions of selected test
        const questions = test.questions || [];
        renderQuestions(questions);
        updateTotalPoints(questions);
    }


    function createNewTest() {
        const newTest = {
            testName: "New Test",
            testId: 'test-' + Math.floor(Math.random() * 1000000),
            questions: []
        };

        quizData.tests.push(newTest);
        currentTestIndex = quizData.tests.length - 1;  // Switch to the last test.

        populateTestSelect();   // Refresh test selection menu
        selectTest(currentTestIndex); // Select new test and populate the rest of the form fields
        clearQuestionForm();

    }

    function addOrUpdateQuestion() {
        const test = quizData.tests[currentTestIndex];
        if(!test){
            alert("No test selected!")
            return;
        }
        const question = document.getElementById("question").value;
        let image = document.getElementById("imagePath").value;
        let imagePreviewData = null;
        
        if (image) {
            const fileName = image.split('/').pop(); // Extract the file name from the path
            image = `test_image_assets/${fileName}`;
            
            // Get the preview data for editing purposes
            const preview = document.getElementById("imagePreview");
            imagePreviewData = preview.dataset.imageData || null;
        }
        const option1 = document.getElementById("option1").value;
        const option2 = document.getElementById("option2").value;
        const option3 = document.getElementById("option3").value;
        const option4 = document.getElementById("option4").value;
        const correctAnswer = document.getElementById("correctAnswer").value;
        const category = document.getElementById("category").value;
        const difficulty = document.getElementById("difficulty").value;
        const points = parseInt(document.getElementById("points").value);


        if(!question || !option1 || !option2 || !option3 || !option4 || !correctAnswer || !category || !difficulty)
        {
            alert("Please fill all the fields")
            return;
        }
        const newQuestion = {
            question: question,
            image: image,
            imagePreviewData: imagePreviewData,
            option1: option1,
            option2: option2,
            option3: option3,
            option4: option4,
            correctAnswer: correctAnswer,
            category: category,
            difficulty: difficulty,
            points: points
        };

        const isEditing = currentQuestionIndex !== null;
        
        if(currentQuestionIndex !== null){
            // Editing existing question - preserve position
            test.questions[currentQuestionIndex] = {...test.questions[currentQuestionIndex], ...newQuestion};
            currentQuestionIndex = null;

        }else{
            // Adding new question - assign next available position
            newQuestion.id = 'q-' + Math.floor(Math.random() * 1000000);
            newQuestion.position = test.questions.length + 1;
            test.questions.push(newQuestion);
            
            // Ensure all questions have positions and update them
            updateQuestionPositions(test.questions);
        }

        clearQuestionForm();
        renderQuestions(test.questions);
        updateTotalPoints(test.questions);
        
        // For new questions: show brief success + auto-scroll back to form
        if (!isEditing) {
            showBriefSuccessAndScrollToForm();
        }

    }




    function renderQuestions(questions) {
        const questionsList = document.getElementById("questions");
        const emptyState = document.getElementById("emptyState");
        
        questionsList.innerHTML = "";
        
        if (questions.length === 0) {
            emptyState.style.display = "block";
            return;
        }
        
        emptyState.style.display = "none";
        
        // Ensure all questions have positions and sort by position for display
        const sortedQuestions = questions
            .map((question, index) => ({
                ...question,
                position: question.position || (index + 1)
            }))
            .sort((a, b) => a.position - b.position);
        
        sortedQuestions.forEach((question, index) => {
            const questionCard = document.createElement("div");
            questionCard.className = "question-card";
            questionCard.dataset.index = index;
            questionCard.style.cssText = `
                background: white; 
                padding: 15px; 
                margin: 10px 0; 
                border-radius: 8px; 
                border-left: 4px solid ${getDifficultyColor(question.difficulty)}; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: all 0.2s ease;
            `;
            
            const difficultyEmoji = getDifficultyEmoji(question.difficulty);
            // Use imagePreviewData if available, otherwise fallback to image path (only if it's a data URL)
            const imageSrc = question.imagePreviewData || (question.image && question.image.startsWith('data:') ? question.image : null);
            const imagePreview = imageSrc ? `<img src="${imageSrc}" style="max-width: 80px; max-height: 50px; object-fit: cover; border-radius: 4px;">` : '';
            
            questionCard.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="question-order" style="flex-shrink: 0; background: #34495e; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">
                        ${index + 1}
                    </div>
                    ${imagePreview ? `<div style="flex-shrink: 0;">${imagePreview}</div>` : ''}
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: ${getDifficultyColor(question.difficulty)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: bold;">
                                ${difficultyEmoji} ${question.difficulty.toUpperCase()}
                            </span>
                            <span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: bold;">
                                ${question.points} pts
                            </span>
                            <span style="background: #95a5a6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: bold;">
                                ${question.category}
                            </span>
                        </div>
                        <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 16px; line-height: 1.3;">${question.question}</h4>
                        <div style="display: flex; gap: 15px; font-size: 13px; color: #7f8c8d; flex-wrap: wrap;">
                            <span><strong>A)</strong> ${question.option1}</span>
                            <span><strong>B)</strong> ${question.option2}</span>
                            <span><strong>C)</strong> ${question.option3}</span>
                            <span><strong>D)</strong> ${question.option4}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px; flex-shrink: 0;">
                        <button onclick="moveQuestionUp(${index})" ${index === 0 ? 'disabled' : ''} 
                                style="background: ${index === 0 ? '#bdc3c7' : '#9b59b6'}; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'}; font-size: 14px; min-height: 36px; font-weight: bold;" 
                                title="Move up">‚Üë</button>
                        <button onclick="moveQuestionDown(${index})" ${index === sortedQuestions.length - 1 ? 'disabled' : ''} 
                                style="background: ${index === sortedQuestions.length - 1 ? '#bdc3c7' : '#9b59b6'}; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: ${index === sortedQuestions.length - 1 ? 'not-allowed' : 'pointer'}; font-size: 14px; min-height: 36px; font-weight: bold;" 
                                title="Move down">‚Üì</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button onclick="editQuestion(${index})" style="background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úèÔ∏è Edit</button>
                        <button onclick="deleteQuestion(${index})" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            
            questionsList.appendChild(questionCard);
        });
    }
    
    function getDifficultyColor(difficulty) {
        switch(difficulty) {
            case 'easy': return '#27ae60';
            case 'medium': return '#f39c12';
            case 'hard': return '#e74c3c';
            default: return '#95a5a6';
        }
    }
    
    function getDifficultyEmoji(difficulty) {
        switch(difficulty) {
            case 'easy': return '‚úì';
            case 'medium': return '‚ö°';
            case 'hard': return '‚≠ê';
            default: return '‚Ä¢';
        }
    }


    function editQuestion(index){

        const test = quizData.tests[currentTestIndex];
        const question = test.questions[index];

        // Smooth scroll to form with animation
        const formSection = document.getElementById("question-form-section");
        formSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });

        // Add visual feedback to the form
        setTimeout(() => {
            const formContainer = formSection.parentElement;
            formContainer.style.transition = 'all 0.3s ease';
            formContainer.style.transform = 'scale(1.02)';
            formContainer.style.boxShadow = '0 4px 20px rgba(52, 152, 219, 0.3)';
            
            // Reset after animation
            setTimeout(() => {
                formContainer.style.transform = '';
                formContainer.style.boxShadow = '';
            }, 600);
        }, 500);

        // Populate form fields
        document.getElementById("question").value = question.question;

        if(question.image){
            document.getElementById("imagePath").value = question.image||"";
            const preview = document.getElementById("imagePreview");
            
            // Use stored preview data if available, otherwise try to load the image path (only if it's a data URL)
            if (question.imagePreviewData) {
                preview.src = question.imagePreviewData;
                preview.dataset.imageData = question.imagePreviewData;
                preview.style.display = 'block';
            } else if (question.image && question.image.startsWith('data:')) {
                preview.src = question.image;
                preview.dataset.imageData = question.image;
                preview.style.display = 'block';
            } else {
                // File path - show placeholder or hide preview
                preview.src = '';
                preview.dataset.imageData = '';
                preview.style.display = 'none';
            }
        }else{
            const preview = document.getElementById("imagePreview");
            preview.src = '';
            preview.dataset.imageData = '';
            preview.style.display = 'none';
        }
        document.getElementById("option1").value = question.option1;
        document.getElementById("option2").value = question.option2;
        document.getElementById("option3").value = question.option3;
        document.getElementById("option4").value = question.option4;
        document.getElementById("correctAnswer").value = question.correctAnswer;
        document.getElementById("category").value = question.category;
        document.getElementById("points").value = question.points;
        document.getElementById("difficulty").value = question.difficulty;

        currentQuestionIndex = index;
        
        // Focus on the question textarea for immediate editing
        setTimeout(() => {
            document.getElementById("question").focus();
        }, 800);
    }


    function deleteQuestion(index) {
        const test = quizData.tests[currentTestIndex];
        test.questions.splice(index, 1);
        renderQuestions(test.questions);
        updateTotalPoints(test.questions);
    }

    // Position management function
    function updateQuestionPositions(questions) {
        questions.forEach((question, index) => {
            question.position = index + 1;
        });
    }

    // Question reordering functions
    function moveQuestionUp(index) {
        if (index <= 0) return;
        
        const test = quizData.tests[currentTestIndex];
        const questions = test.questions;
        
        // Swap questions
        [questions[index - 1], questions[index]] = [questions[index], questions[index - 1]];
        
        // Update positions
        updateQuestionPositions(questions);
        
        // Re-render and update
        renderQuestions(questions);
        updateTotalPoints(questions);
    }

    function moveQuestionDown(index) {
        const test = quizData.tests[currentTestIndex];
        const questions = test.questions;
        
        if (index >= questions.length - 1) return;
        
        // Swap questions
        [questions[index], questions[index + 1]] = [questions[index + 1], questions[index]];
        
        // Update positions
        updateQuestionPositions(questions);
        
        // Re-render and update
        renderQuestions(questions);
        updateTotalPoints(questions);
    }

    // Drag and drop functionality
    let draggedElement = null;
    let draggedIndex = null;
    let isDragging = false;

    function handleDragStart(e) {
        if (!e.target.closest('.drag-handle')) {
            e.preventDefault();
            return false;
        }
        
        draggedElement = this;
        draggedIndex = parseInt(this.dataset.index);
        isDragging = true;
        
        // Add dragging class for smooth CSS transitions
        this.classList.add('dragging');
        
        // Set drag image to be the entire card
        const dragImage = this.cloneNode(true);
        dragImage.style.transform = 'rotate(3deg)';
        dragImage.style.opacity = '0.8';
        e.dataTransfer.setDragImage(dragImage, e.offsetX, e.offsetY);
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedIndex.toString());
        
        // Delay to prevent immediate style application
        setTimeout(() => {
            if (isDragging) {
                this.style.opacity = '0.3';
            }
        }, 0);
    }

    function handleDragOver(e) {
        e.preventDefault();
        
        if (!isDragging || this === draggedElement) {
            return;
        }
        
        // Get the bounding rectangle and mouse position
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        // Determine if we're in the top or bottom half
        if (e.clientY < midY) {
            this.classList.add('drag-over-top');
            this.classList.remove('drag-over-bottom');
        } else {
            this.classList.add('drag-over-bottom');
            this.classList.remove('drag-over-top');
        }
        
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragLeave(e) {
        // Only remove classes if we're actually leaving the element
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drag-over-top', 'drag-over-bottom');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!isDragging || this === draggedElement) {
            return;
        }
        
        const dropIndex = parseInt(this.dataset.index);
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        // Determine final drop position
        let finalDropIndex = dropIndex;
        if (e.clientY >= midY) {
            finalDropIndex = dropIndex + 1;
        }
        
        // Adjust for removal of dragged element
        if (draggedIndex < finalDropIndex) {
            finalDropIndex--;
        }
        
        if (draggedIndex !== finalDropIndex) {
            const test = quizData.tests[currentTestIndex];
            const questions = test.questions;
            
            // Remove the dragged item and insert it at the new position
            const draggedQuestion = questions.splice(draggedIndex, 1)[0];
            questions.splice(finalDropIndex, 0, draggedQuestion);
            
            // Update positions
            updateQuestionPositions(questions);
            
            // Re-render with smooth transition
            renderQuestions(questions);
            updateTotalPoints(questions);
        }
        
        // Clear all visual feedback
        clearDragStyles();
    }

    function handleDragEnd(e) {
        isDragging = false;
        clearDragStyles();
    }
    
    function clearDragStyles() {
        // Clear drag state
        draggedElement = null;
        draggedIndex = null;
        
        // Remove all drag-related classes and styles
        const allCards = document.querySelectorAll('.question-card');
        allCards.forEach(card => {
            card.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom');
            card.style.opacity = '';
            card.style.transform = '';
        });
    }

    function showBriefSuccessAndScrollToForm() {
        // Show success message with user choices
        showSuccessWithChoices();
    }

    function showSuccessWithChoices() {
        // Remove any existing choice dialog
        const existing = document.getElementById('success-choices');
        if (existing) existing.remove();

        // Create success dialog with choices
        const choiceDiv = document.createElement('div');
        choiceDiv.id = 'success-choices';
        choiceDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: scaleIn 0.3s ease;
            text-align: center;
            min-width: 400px;
            max-width: 90vw;
        `;
        
        choiceDiv.innerHTML = `
            <div style="margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <h2 style="margin: 0 0 10px 0; color: #27ae60; font-size: 24px;">Question Added Successfully!</h2>
                <p style="margin: 0; color: #7f8c8d; font-size: 16px;">What would you like to do next?</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="addAnotherQuestion()" style="
                    background: linear-gradient(135deg, #3498db, #2980b9);
                    color: white;
                    border: none;
                    padding: 15px 25px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <span style="font-size: 20px;">‚ûï</span>
                    <span>Add Another Question</span>
                </button>
                
                <button onclick="reviewAndOrder()" style="
                    background: linear-gradient(135deg, #9b59b6, #8e44ad);
                    color: white;
                    border: none;
                    padding: 15px 25px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <span style="font-size: 20px;">üìù</span>
                    <span>Review & Reorder Questions</span>
                </button>
                
                <button onclick="saveQuiz()" style="
                    background: linear-gradient(135deg, #27ae60, #229954);
                    color: white;
                    border: none;
                    padding: 15px 25px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <span style="font-size: 20px;">üíæ</span>
                    <span>Save & Export Quiz</span>
                </button>
                
                <button onclick="closeSuccessDialog()" style="
                    background: none;
                    color: #95a5a6;
                    border: 2px solid #ecf0f1;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    margin-top: 10px;
                ">
                    ‚úï Just Close This
                </button>
            </div>
        `;

        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.id = 'success-backdrop';
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            animation: fadeIn 0.3s ease;
        `;
        backdrop.onclick = closeSuccessDialog;

        document.body.appendChild(backdrop);
        document.body.appendChild(choiceDiv);
    }

    function addAnotherQuestion() {
        closeSuccessDialog();
        document.getElementById("question-form-section").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        setTimeout(() => {
            document.getElementById("question").focus();
        }, 500);
    }

    function reviewAndOrder() {
        closeSuccessDialog();
        document.getElementById("questionList").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }

    function saveQuiz() {
        closeSuccessDialog();
        // Scroll to the download section
        const downloadSection = document.querySelector('h2:contains("Download")') || document.querySelector('[style*="Download"]');
        if (downloadSection) {
            downloadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            // Fallback: scroll to bottom where download buttons typically are
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
    }

    function closeSuccessDialog() {
        const dialog = document.getElementById('success-choices');
        const backdrop = document.getElementById('success-backdrop');
        
        if (dialog) {
            dialog.style.animation = 'scaleOut 0.3s ease';
            setTimeout(() => {
                if (dialog.parentNode) dialog.remove();
            }, 300);
        }
        
        if (backdrop) {
            backdrop.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                if (backdrop.parentNode) backdrop.remove();
            }, 300);
        }
    }

    function showAddAnotherQuestionPrompt() {
        console.log('showAddAnotherQuestionPrompt called');
        
        // Remove any existing prompt
        const existingPrompt = document.getElementById('add-another-prompt');
        if (existingPrompt) {
            console.log('Removing existing prompt');
            existingPrompt.remove();
        }

        // Create success message with add another option
        const promptDiv = document.createElement('div');
        promptDiv.id = 'add-another-prompt';
        promptDiv.style.cssText = `
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            text-align: center;
            animation: slideIn 0.5s ease;
        `;
        
        promptDiv.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                <span style="font-size: 24px;">‚úÖ</span>
                <h3 style="margin: 0; font-size: 18px;">Question Added Successfully!</h3>
            </div>
            <p style="margin: 10px 0; opacity: 0.9;">Your question has been added to the quiz.</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="scrollToAddQuestion()" style="
                    background: white; 
                    color: #27ae60; 
                    border: none; 
                    padding: 12px 24px; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-weight: bold;
                    font-size: 14px;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ûï Add Another Question
                </button>
                <button onclick="scrollToQuestionList()" style="
                    background: rgba(255,255,255,0.2); 
                    color: white; 
                    border: 2px solid white; 
                    padding: 10px 24px; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-weight: bold;
                    font-size: 14px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    üìã View All Questions
                </button>
                <button onclick="hideAddAnotherPrompt()" style="
                    background: none; 
                    color: white; 
                    border: none; 
                    padding: 10px; 
                    cursor: pointer; 
                    font-size: 12px; 
                    opacity: 0.7;
                    text-decoration: underline;
                ">
                    ‚úï Dismiss
                </button>
            </div>
        `;

        // Try multiple insertion strategies
        const formSection = document.getElementById("question-form-section");
        console.log('Form section found:', formSection);
        
        let inserted = false;
        
        // Strategy 1: Insert after form section
        if (formSection && formSection.parentNode) {
            formSection.parentNode.insertBefore(promptDiv, formSection.nextSibling);
            console.log('Prompt inserted after form section');
            inserted = true;
        }
        
        // Strategy 2: Insert after the entire form container
        if (!inserted) {
            const container = document.querySelector('.container');
            if (container) {
                // Find the form area and insert after it
                const formArea = container.querySelector('h2#question-form-section').parentElement;
                if (formArea) {
                    formArea.appendChild(promptDiv);
                    console.log('Prompt appended to form area');
                    inserted = true;
                }
            }
        }
        
        // Strategy 3: Insert at top of body as fallback
        if (!inserted) {
            document.body.insertBefore(promptDiv, document.body.firstChild);
            console.log('Prompt inserted at top of body as fallback');
        }

        // Auto-hide after 8 seconds
        setTimeout(() => {
            if (promptDiv.parentNode) {
                promptDiv.style.transition = 'all 0.5s ease';
                promptDiv.style.opacity = '0';
                promptDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (promptDiv.parentNode) {
                        promptDiv.remove();
                    }
                }, 500);
            }
        }, 8000);
    }

    function scrollToAddQuestion() {
        hideAddAnotherPrompt();
        document.getElementById("question-form-section").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        setTimeout(() => {
            document.getElementById("question").focus();
        }, 500);
    }

    function scrollToQuestionList() {
        hideAddAnotherPrompt();
        document.getElementById("questionList").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }

    function hideAddAnotherPrompt() {
        const prompt = document.getElementById('add-another-prompt');
        if (prompt) {
            prompt.style.transition = 'all 0.3s ease';
            prompt.style.opacity = '0';
            prompt.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                if (prompt.parentNode) {
                    prompt.remove();
                }
            }, 300);
        }
    }

    function clearQuestionForm(){
        document.getElementById("question").value = "";
        document.getElementById("imagePath").value = "";
        document.getElementById("option1").value = "";
        document.getElementById("option2").value = "";
        document.getElementById("option3").value = "";
        document.getElementById("option4").value = "";
        document.getElementById("correctAnswer").value = "option1";
        document.getElementById("category").value = "";
        document.getElementById("points").value = 1;
        document.getElementById("difficulty").value = "easy";
        
        // Hide image preview
        const preview = document.getElementById("imagePreview");
        preview.src = '';
        preview.dataset.imageData = '';
        preview.style.display = 'none';
        
        currentQuestionIndex = null;
    }

    function generateJSON() {
        // Update testName from the input element
        const testNameInput = document.getElementById("testName").value;
        const test = quizData.tests[currentTestIndex];
        test.testName = testNameInput;

        // Ensure all questions have positions and sort by position
        const sortedQuestions = test.questions
            .map((question, index) => ({
                ...question,
                position: question.position || (index + 1)
            }))
            .sort((a, b) => a.position - b.position);

        // Create a new object for JSON output
        const outputTest = {
            testName: test.testName,
            testID: test.testId,
            questions: sortedQuestions.map(question => {
                // Convert option selection to letter
                const optionToLetter = {
                    'option1': 'A',
                    'option2': 'B', 
                    'option3': 'C',
                    'option4': 'D'
                };
                
                return {
                    question: question.question,
                    image: question.image ? `images/${question.id}_image.${getImageExtension(question.image)}` : null,
                    options: {
                        A: question.option1,
                        B: question.option2,
                        C: question.option3,
                        D: question.option4
                    },
                    correctAnswer: optionToLetter[question.correctAnswer],
                    category: question.category,
                    difficulty: question.difficulty,
                    points: question.points,
                    position: question.position,
                    id: question.id
                };
            })
        };

        const jsonData = JSON.stringify({tests: [outputTest]}, null, 4);
        document.getElementById("jsonOutput").innerText = jsonData;
        return jsonData;


    }
    async function downloadZIP() {
        // Check if JSZip is available
        if (typeof JSZip === 'undefined') {
            alert('ZIP functionality is not available. Please download the JSON file instead or ensure jszip.min.js is in the same folder.');
            return;
        }
        
        const jsonData = generateJSON();
        if (!jsonData) return;

        const test = quizData.tests[currentTestIndex];
        const testName = test.testName.replace(/\s+/g, '_');
        const testID = test.testId;
        const date = new Date().toISOString().split('T')[0];

        const zip = new JSZip();
        
        // Add JSON file
        zip.file(`${testName}_${testID}_${date}.json`, jsonData);
        
        // Add images folder
        const imagesFolder = zip.folder("images");
        
        // Collect all images from questions
        const imagePromises = test.questions
            .filter(q => q.imagePreviewData) // Only questions with actual image data
            .map(async (question) => {
                try {
                    const imageData = question.imagePreviewData;
                    const extension = getImageExtension(imageData);
                    const filename = `${question.id}_image.${extension}`;
                    
                    // Convert data URL to blob
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    
                    imagesFolder.file(filename, blob);
                } catch (error) {
                    console.error(`Error processing image for question ${question.id}:`, error);
                }
            });
            
        // Wait for all images to be processed
        await Promise.all(imagePromises);
        
        // Generate and download ZIP
        const zipBlob = await zip.generateAsync({type: "blob"});
        const url = URL.createObjectURL(zipBlob);
        
        const a = document.createElement("a");
        a.href = url;
        a.download = `${testName}_${testID}_${date}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Generate JSON with embedded images for standalone use
    function generateEmbeddedJSON() {
        const testNameInput = document.getElementById("testName").value;
        const test = quizData.tests[currentTestIndex];
        test.testName = testNameInput;

        const optionToLetter = {
            'option1': 'A',
            'option2': 'B', 
            'option3': 'C',
            'option4': 'D'
        };
        
        // Ensure all questions have positions and sort by position
        const sortedQuestions = test.questions
            .map((question, index) => ({
                ...question,
                position: question.position || (index + 1)
            }))
            .sort((a, b) => a.position - b.position);

        const outputTest = {
            testName: test.testName,
            testID: test.testId,
            questions: sortedQuestions.map(question => ({
                question: question.question,
                image: question.imagePreviewData, // Use embedded image data
                options: {
                    A: question.option1,
                    B: question.option2,
                    C: question.option3,
                    D: question.option4
                },
                correctAnswer: optionToLetter[question.correctAnswer],
                category: question.category,
                difficulty: question.difficulty,
                points: question.points,
                position: question.position,
                id: question.id
            }))
        };

        return JSON.stringify({tests: [outputTest]}, null, 4);
    }

    // Download JSON with embedded images for compatibility
    function downloadJSON() {
        const jsonData = generateEmbeddedJSON();
        if (!jsonData) return;

        const test = quizData.tests[currentTestIndex];
        const testName = test.testName.replace(/\s+/g, '_');
        const testID = test.testId;
        const date = new Date().toISOString().split('T')[0];

        const filename = `${testName}_${testID}_${date}.json`;

        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function updateTotalPoints(questions) {
        const totalPoints = questions.reduce((sum, question) => sum + question.points, 0);
        const questionCount = questions.length;
        
        // Update summary cards
        document.getElementById("totalPointsDisplay").innerText = totalPoints;
        document.getElementById("questionCount").innerText = questionCount;
        
        // Calculate difficulty breakdown
        const difficulties = questions.reduce((acc, q) => {
            acc[q.difficulty] = (acc[q.difficulty] || 0) + 1;
            return acc;
        }, {});
        
        const difficultyText = questionCount > 0 ? 
            `${difficulties.easy || 0} Easy, ${difficulties.medium || 0} Medium, ${difficulties.hard || 0} Hard` :
            'No questions yet';
            
        document.getElementById("difficultyBreakdown").innerText = difficultyText;
    }

</script>
</body>
</html>